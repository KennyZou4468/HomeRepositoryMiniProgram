<!-- pages/detail/detail.wxml -->
<wxs module="utils">
  module.exports.formatTime = function(timestamp) {
    var date = getDate(timestamp * 1000);
    var now = getDate();
    var diff = Math.floor((now.getTime() - date.getTime()) / 1000);
    
    if (diff < 60) return 'åˆšåˆš';
    if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
    if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
    if (diff < 604800) return Math.floor(diff / 86400) + 'å¤©å‰';
    
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();
    return month + '/' + day + ' ' + (hour < 10 ? '0' + hour : hour) + ':' + (minute < 10 ? '0' + minute : minute);
  }
</wxs>
<view class="container {{darkMode ? 'theme-dark' : ''}} {{elderMode ? 'elder-mode' : ''}} page-enter" wx:if="{{item}}">
  <!-- æŸ¥çœ‹æ¨¡å¼ -->
  <view class="detail-card card-animate" wx:if="{{!isEditing}}">
    <!-- ç‰©å“åç§° -->
    <view class="item-header">
      <text class="item-icon">ğŸ“¦</text>
      <view class="item-title-wrapper">
        <text class="item-name">{{item.name}}</text>
        <text class="item-category" wx:if="{{item.category}}">ğŸ·ï¸ {{item.category}}</text>
      </view>
    </view>
    <!-- æ•°é‡è°ƒèŠ‚ -->
    <view class="count-section">
      <text class="count-label">ğŸ§® å½“å‰æ•°é‡</text>
      <view class="count-control">
        <view class="count-btn decrease {{item.count <= 0 ? 'disabled' : ''}}" bindtap="onDecrease">
          <text>ï¼</text>
        </view>
        <view class="count-value-wrapper">
          <view class="count-value {{item.count <= 2 ? 'low-count' : ''}} {{countAnimate ? 'count-animate' : ''}}">
            {{item.count}}
          </view>
          <view class="count-unit" wx:if="{{item.unit}}">{{item.unit}}</view>
        </view>
        <view class="count-btn increase" bindtap="onIncrease">
          <text>ï¼‹</text>
        </view>
      </view>
      <text class="low-count-tip" wx:if="{{item.count <= 2}}">âš ï¸ å¿«ç”¨å®Œå•¦ï¼Œè®°å¾—è¡¥è´§ï½</text>
    </view>
    <!-- ç‰©å“ä¿¡æ¯ -->
    <view class="info-section">
      <view class="info-item">
        <text class="info-label">ğŸ“ å­˜æ”¾ä½ç½®</text>
        <text class="info-value" user-select>{{item.location}}</text>
      </view>
      <view class="info-item" wx:if="{{item.note}}">
        <text class="info-label">ğŸ“ å¤‡æ³¨</text>
        <view class="note-wrapper">
          <text class="info-value note-content {{noteExpanded ? 'expanded' : 'collapsed'}}" user-select>
            {{item.note}}
          </text>
          <view class="note-expand-btn" wx:if="{{item.note.length > 80}}" bindtap="toggleNoteExpand">
            <text>{{noteExpanded ? 'æ”¶èµ· â–²' : 'å±•å¼€ â–¼'}}</text>
          </view>
        </view>
      </view>
    </view>
    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="btn btn-edit" bindtap="onEdit">âœï¸ ç¼–è¾‘ä¿¡æ¯</button>
      <button class="btn btn-delete" bindtap="onDelete">ğŸ—‘ï¸ åˆ é™¤ç‰©å“</button>
    </view>
    <!-- åº“å­˜å˜æ›´è®°å½• -->
    <view class="history-section" wx:if="{{item.history && item.history.length > 0}}">
      <view class="history-header">
        <text class="history-title">ğŸ“‹ æœ€è¿‘å˜æ›´</text>
        <text class="history-count">{{item.history.length}}æ¡è®°å½•</text>
      </view>
      <view class="history-list">
        <view class="history-item" wx:for="{{item.history}}" wx:key="time" wx:for-item="record">
          <view class="history-delta {{record.delta > 0 ? 'delta-plus' : 'delta-minus'}}">
            {{record.delta > 0 ? '+' : ''}}{{record.delta}}
          </view>
          <view class="history-info">
            <text class="history-after">å‰©ä½™ {{record.after}}{{item.unit || ''}}</text>
            <text class="history-time">{{utils.formatTime(record.time)}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
  <!-- ç¼–è¾‘æ¨¡å¼ -->
  <view class="edit-card card-animate" wx:if="{{isEditing}}">
    <view class="edit-header">
      <text class="edit-title">âœï¸ ç¼–è¾‘ç‰©å“ä¿¡æ¯</text>
    </view>
    <view class="form">
      <!-- ç‰©å“åç§° -->
      <view class="form-item">
        <view class="form-label">
          <text class="label-emoji">ğŸ“¦</text>
          <text>ç‰©å“åç§°</text>
          <text class="required">*</text>
        </view>
        <input class="form-input" placeholder="è¿™æ˜¯ä»€ä¹ˆç‰©å“å‘€ï¼Ÿ" value="{{editData.name}}" bindinput="onNameInput" maxlength="50" />
      </view>
      <!-- å•ä½ï¼ˆå¯é€‰ï¼Œå¯æŠ˜å ï¼‰ -->
      <view class="form-item form-item-collapsible" wx:if="{{showUnitField || editData.unit}}">
        <view class="form-label">
          <text class="label-emoji">ğŸ“</text>
          <text>å•ä½</text>
          <text class="optional">é€‰å¡«</text>
          <text class="collapse-btn" bindtap="hideUnitField">æ”¶èµ·</text>
        </view>
        <input class="form-input" placeholder="ä¸ªã€ä»¶ã€ç›’ã€ç“¶..." value="{{editData.unit}}" bindinput="onUnitInput" maxlength="10" />
      </view>
      <view class="add-field-btn" wx:if="{{!showUnitField && !editData.unit}}" bindtap="showUnitFieldTap">
        <text class="add-field-icon">ï¼‹</text>
        <text class="add-field-text">æ·»åŠ å•ä½</text>
      </view>
      <!-- å­˜æ”¾ä½ç½® -->
      <view class="form-item">
        <view class="form-label">
          <text class="label-emoji">ğŸ“</text>
          <text>å­˜æ”¾ä½ç½®</text>
          <text class="required">*</text>
        </view>
        <view class="form-select" bindtap="openLocationPicker">
          <view class="{{editData.location ? 'select-value' : 'select-placeholder'}}">
            {{editData.location || 'ç‚¹å‡»é€‰æ‹©å­˜æ”¾ä½ç½®'}}
          </view>
          <view class="select-arrow">â–¼</view>
        </view>
      </view>
      <!-- åˆ†ç±» -->
      <view class="form-item">
        <view class="form-label">
          <text class="label-emoji">ğŸ·ï¸</text>
          <text>åˆ†ç±»</text>
          <text class="optional">é€‰å¡«</text>
        </view>
        <view class="form-select" bindtap="openCategoryPicker">
          <view class="{{editData.category ? 'select-value' : 'select-placeholder'}}">
            {{editData.category || 'ç‚¹å‡»é€‰æ‹©åˆ†ç±»'}}
          </view>
          <view class="select-arrow">â–¼</view>
        </view>
      </view>
      <!-- å¤‡æ³¨ -->
      <view class="form-item">
        <view class="form-label">
          <text class="label-emoji">ğŸ“</text>
          <text>å¤‡æ³¨</text>
          <text class="optional">é€‰å¡«</text>
          <text class="char-limit">{{editData.note.length || 0}}/250</text>
        </view>
        <textarea class="form-textarea" placeholder="æœ‰ä»€ä¹ˆè¦è®°ä½çš„å—ï¼Ÿï¼ˆæœ€å¤š250å­—ï¼‰" value="{{editData.note}}" bindinput="onNoteInput" maxlength="250" auto-height="{{true}}" />
      </view>
    </view>
    <!-- ç¼–è¾‘æ¨¡å¼æŒ‰é’® -->
    <view class="button-group">
      <button class="btn btn-cancel" bindtap="onCancelEdit">å–æ¶ˆ</button>
      <button class="btn btn-save" bindtap="onSaveEdit">âœ“ ä¿å­˜ä¿®æ”¹</button>
    </view>
  </view>
</view>
<!-- ä½ç½®é€‰æ‹©å™¨å¼¹çª— -->
<view class="picker-mask {{darkMode ? 'theme-dark' : ''}}" wx:if="{{showLocationPicker}}" bindtap="closeLocationPicker"></view>
<view class="picker-popup {{darkMode ? 'theme-dark' : ''}} {{showLocationPicker ? 'show' : ''}}">
  <view class="picker-header">
    <text class="picker-title">ğŸ“ é€‰æ‹©å­˜æ”¾ä½ç½®</text>
    <text class="picker-close" bindtap="closeLocationPicker">âœ•</text>
  </view>
  <scroll-view class="picker-list" scroll-y>
    <view class="picker-item {{editData.location === item ? 'selected' : ''}}" wx:for="{{allLocations}}" wx:key="*this" data-value="{{item}}" bindtap="onSelectLocation">
      <view class="picker-item-text">{{item}}</view>
      <view class="picker-check" wx:if="{{editData.location === item}}">âœ“</view>
    </view>
  </scroll-view>
  <!-- æ·»åŠ æ–°ä½ç½® -->
  <view class="picker-add-section">
    <view class="picker-add-btn" bindtap="showAddLocation" wx:if="{{!showAddLocationInput}}">
      <text>ï¼‹ æ·»åŠ æ–°ä½ç½®</text>
    </view>
    <view class="picker-add-input-wrapper" wx:if="{{showAddLocationInput}}">
      <input class="picker-add-input" placeholder="è¾“å…¥æ–°ä½ç½®åç§°" value="{{newLocationInput}}" bindinput="onNewLocationInput" focus="{{showAddLocationInput}}" maxlength="20" />
      <button class="picker-add-confirm" bindtap="confirmAddLocation">ç¡®å®š</button>
    </view>
  </view>
</view>
<!-- åˆ†ç±»é€‰æ‹©å™¨å¼¹çª— -->
<view class="picker-mask {{darkMode ? 'theme-dark' : ''}}" wx:if="{{showCategoryPicker}}" bindtap="closeCategoryPicker"></view>
<view class="picker-popup {{darkMode ? 'theme-dark' : ''}} {{showCategoryPicker ? 'show' : ''}}">
  <view class="picker-header">
    <text class="picker-title">ğŸ·ï¸ é€‰æ‹©åˆ†ç±»</text>
    <text class="picker-close" bindtap="closeCategoryPicker">âœ•</text>
  </view>
  <scroll-view class="picker-list" scroll-y>
    <view class="picker-item {{editData.category === item ? 'selected' : ''}}" wx:for="{{allCategories}}" wx:key="*this" data-value="{{item}}" bindtap="onSelectCategory">
      <view class="picker-item-text">{{item}}</view>
      <view class="picker-check" wx:if="{{editData.category === item}}">âœ“</view>
    </view>
  </scroll-view>
  <!-- æ·»åŠ æ–°åˆ†ç±» -->
  <view class="picker-add-section">
    <view class="picker-add-btn" bindtap="showAddCategory" wx:if="{{!showAddCategoryInput}}">
      <text>ï¼‹ æ·»åŠ æ–°åˆ†ç±»</text>
    </view>
    <view class="picker-add-input-wrapper" wx:if="{{showAddCategoryInput}}">
      <input class="picker-add-input" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°" value="{{newCategoryInput}}" bindinput="onNewCategoryInput" focus="{{showAddCategoryInput}}" maxlength="20" />
      <button class="picker-add-confirm" bindtap="confirmAddCategory">ç¡®å®š</button>
    </view>
  </view>
</view>